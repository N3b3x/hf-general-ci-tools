---
name: ðŸ” [RU] C++ Static Analysis

on:
  workflow_call:
    inputs:
      paths:
        description: "Dirs to analyze (space-separated)"
        type: string
        required: false
        default: "src inc examples"
      std:
        description: "C++ standard"
        type: string
        required: false
        default: "c++17"
      strict:
        description: "Fail job if any issues found"
        type: boolean
        required: false
        default: false
      exclude:
        description: "Paths to exclude (space-separated)"
        type: string
        required: false
        default: ""
      enable:
        description: >
          Checks to enable (comma-separated: all,warning,style,performance,
          portability,information,unusedFunction,missingInclude)
        type: string
        required: false
        default: "warning,style,performance,portability,information"
      force:
        description: "Force checking even with incomplete analysis"
        type: boolean
        required: false
        default: false
      max_configs:
        description: >
          Maximum configs to check (for template-heavy code, 0=unlimited)
        type: number
        required: false
        default: 0

jobs:
  cppcheck:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Run cppcheck (Docker)
        id: run
        shell: bash
        run: |
          set -e
          paths="${{ inputs.paths }}"
          exclude="${{ inputs.exclude }}"
          enable="${{ inputs.enable }}"
          force="${{ inputs.force }}"
          max_configs="${{ inputs.max_configs }}"

          # Build cppcheck command
          CPPCHECK_CMD="cppcheck --enable=$enable"
          # Suppress missingIncludeSystem warnings (common for system headers)
          # Also suppress unmatchedSuppression info messages when suppressions don't match
          CPPCHECK_CMD="$CPPCHECK_CMD --suppress=missingIncludeSystem"
          CPPCHECK_CMD="$CPPCHECK_CMD --suppress=unmatchedSuppression"
          CPPCHECK_CMD="$CPPCHECK_CMD --inline-suppr"
          CPPCHECK_CMD="$CPPCHECK_CMD --std=${{ inputs.std }}"

          # Add force option if enabled
          if [ "$force" = "true" ]; then
            CPPCHECK_CMD="$CPPCHECK_CMD --force"
          fi

          # Add max-configs if specified
          if [ "$max_configs" != "0" ] && [ -n "$max_configs" ]; then
            CPPCHECK_CMD="$CPPCHECK_CMD --max-configs=$max_configs"
          fi

          CPPCHECK_CMD="$CPPCHECK_CMD --xml"
          CPPCHECK_CMD="$CPPCHECK_CMD --output-file=/src/cppcheck_report.xml"

          # Add exclude options if specified
          if [ -n "$exclude" ]; then
            for ex in $exclude; do
              CPPCHECK_CMD="$CPPCHECK_CMD --exclude=/src/$ex"
            done
          fi

          # Add paths to analyze
          for p in $paths; do
            CPPCHECK_CMD="$CPPCHECK_CMD /src/$p"
          done

          docker run --rm -v "$PWD":/src ghcr.io/facthunder/cppcheck:latest \
            $CPPCHECK_CMD 2>&1 | \
            tee cppcheck_output.txt || true

          if [ -s cppcheck_report.xml ]; then
            echo "issues=true" >> "$GITHUB_OUTPUT"
          else
            echo "issues=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Upload report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: cppcheck-report
          path: |
            cppcheck_report.xml
            cppcheck_output.txt
          retention-days: 14

      - name: Fail on issues (strict)
        if: ${{ inputs.strict && steps.run.outputs.issues == 'true' }}
        run: |
          echo "Cppcheck reported issues (strict mode)"; exit 1
